clear all;

% simple 2 node network 
num = 3;

% Adjacency matrix
    A = make_chain(num);

%    A = lattice(num/2);

% making Laplacian matrix from adjacency
L = laplac(A);

% RM model params
r = 1;
c = 0.2;
m = 1;

% tfinal - for ode45
t0 = 0;
tfinal = 120000;

% fraction of transcient data to disregard for 0-1 test
thresh = 1/6;

% random initial conditions
y0 = rand(num*2,1)*0.4;

% vector of k and sigma values to loop through
kvec = [5];
sigmavec = [1e-5];

% setting up array to store 0-1 test values
score = zeros(length(kvec),1);


opts = odeset('RelTol',1e-6,'AbsTol',1e-9);
S = zeros(length(kvec),length(sigmavec));
for i = 1:length(kvec)
    k = kvec(i);
    disp(i);
    for j = 1:length(sigmavec)
        disp(j);
        sigma = sigmavec(j);
        % RHS function
        func = @(t,y)RM_rhs_1(y,r,m,c,k,sigma,L,num);
        
        [t,sol] = ode45(func,[t0:0.1:tfinal],y0,opts);
        %[t,sol] = ode45(func,[tfinal tfinal1],sol(end,:),opts1);
        
        % disregarding transcient data
        Len = length(sol);
        ind = round((1-thresh)*Len);
        % column of data (1 = prey in node 1)
        column = 1;
        
        vec = sol(end-ind:end,column);
        % sampling rate for 0-1 test
        s_rate = 2000;
        zvec = vec(s_rate:s_rate:end);
        
        % result of 0-1 test
        score = z1test(zvec);
        
        S(i,j) = score;
    end
    
end

%%
[t,sol] = ode45(func,[t0 tfinal],y0,opts);

y0 = sol(end,:)';

y1 = y0+(rand(2*num,1)/100000);
y2 = y0+(rand(2*num,1)/100000);
y3 = y0+(rand(2*num,1)/100000);
y4 = y0+(rand(2*num,1)/100000);
y5 = y0+(rand(2*num,1)/100000);
y6 = y0+(rand(2*num,1)/100000);

opts1 = odeset('RelTol',1e-5,'AbsTol',1e-5);
func = @(t,y)RM_rhs_1(y,r,m,c,k,sigma,L,num);
[t,sol1] = ode45(func,[t0 tfinal],y1,opts1);
[t,sol2] = ode45(func,[t0 tfinal],y2,opts1);
[t,sol3] = ode45(func,[t0 tfinal],y3,opts1);
[t,sol4] = ode45(func,[t0 tfinal],y4,opts1);
[t,sol5] = ode45(func,[t0 tfinal],y5,opts1);
[t,sol6] = ode45(func,[t0 tfinal],y6,opts1);


 %%
% h = figure(6);
% filename = '3nodechaos2.gif';
% axis tight manual
 for j = 1:size(sol,1)
%     

plot3(sol1(j:j+1,1),sol1(j:j+1,2),sol1(j:j+1,3),'b')
hold on
plot3(sol2(j:j+1,1),sol2(j:j+1,2),sol2(j:j+1,3),'g')
hold on
plot3(sol3(j:j+1,1),sol3(j:j+1,2),sol3(j:j+1,3),'k')
hold on
plot3(sol4(j:j+1,1),sol4(j:j+1,2),sol4(j:j+1,3),'y')
hold on
plot3(sol5(j:j+1,1),sol5(j:j+1,2),sol5(j:j+1,3),'c')
hold on
plot3(sol6(j:j+1,1),sol6(j:j+1,2),sol6(j:j+1,3),'m')
hold on

xlim([0 6])
ylim([0 6])
zlim([0 6])
xlabel('Node 1')
ylabel('Node 2')
zlabel('Node 3')
title('Evolution of prey')
axis tight manual
drawnow
%     % Capture frames as images
%     frame = getframe(h);
%     im = frame2im(frame);
%     [imind,cm] = rgb2ind(im,256);
%     
%         
%     % Write GIF to file
%     if j == 1
%         imwrite(imind,cm,filename,'gif','Loopcount',inf);
%     else
%        imwrite(imind,cm,filename,'gif','WriteMode','append');
%     end
%     if j == 1
%         pause(2)
%     end
 end
% 
% 
